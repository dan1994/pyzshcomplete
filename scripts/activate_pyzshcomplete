#!/usr/bin/python3

from os.path import join, dirname, expanduser
from os import remove, geteuid
from sys import stderr, exit
from glob import glob


def main():
    try:
        print_notices()
        avoid_running_as_super_user_implicitly()
        remove_completion_system_cache_files()
        print_addition_to_zshrc()
    except Exception as e:
        stderr.write('An error occured during activation: {}\n'.
                     format(str(e)))
        exit(-1)


def print_notices():
    print('Activating pyzshcomplete...')
    print('NOTE 1: This activation is per user.')
    print('NOTE 2: It is preferable to always use the same pyzshcomplete '
          'version across virtual environments and the global environment for a '
          'specific user, since there are shared assets across all '
          'installations.\n')


def avoid_running_as_super_user_implicitly():
    if geteuid() == 0:
        if input('You seem to be running as a super user. If you have a user '
                 'account for which you would like to activate pyzshcomplete, '
                 'you should run this script from that user.\nContinue? '
                 '[y/N] ') .lower() != 'y':
            print('Aborting...')
            exit(0)
        print('Continuing...')


def remove_completion_system_cache_files():
    print('Removing completion system cache files...')
    zsh_completion_cache_files = glob(expanduser('~/.zcompdump*'))
    for cache_file in zsh_completion_cache_files:
        try:
            remove(cache_file)
        except:
            stderr.write('WARNING: Failed removing zsh cache file: {}. You can '
                         'try to remove it manually.'.format(cache_file))


def print_addition_to_zshrc():
    print('Please add the following line to the begining of your .zshrc '
          '(anywhere before calling autoload): ')
    print('fpath=({} $fpath)'.format(get_completion_scripts_dir()))
    input('Press any key to continue...')
    print('Please restart zsh for changes to take effect')
    print('NOTE: Sourcing .zshrc is not enough')


def get_completion_scripts_dir():
    try:
        import pyzshcomplete
    except ImportError as e:
        raise ImportError('{}: Make sure the module is installed for the user '
                          'running the activation script'.format(str(e)))

    pyzshcomplete_root_dir = dirname(pyzshcomplete.__file__)
    return join(pyzshcomplete_root_dir, 'zsh_scripts')


if __name__ == '__main__':
    main()
